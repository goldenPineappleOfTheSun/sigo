<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Игра</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        .container {
            display: grid;
            grid-template-columns: 300px 1fr 0;
            grid-template-rows: 1fr auto;
            height: 70vh;
            gap: 10px;
            padding: 10px;
        }

        /* Левая зона - ведущий */
        .host-zone {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .host-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid #fff;
            object-fit: cover;
        }

        .host-name {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }

        .host-bubble {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 10px 15px;
            border-radius: 15px;
            min-height: 50px;
            width: 100%;
            font-size: 14px;
            text-align: center;
            word-wrap: break-word;
        }

        /* Центральная зона */
        .center-zone {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .center-zone.hidden {
            display: none;
        }

        /* Таблица вопросов */
        .question-table {
            width: 100%;
            height: 100%;
            border-collapse: collapse;
        }

        .question-table th,
        .question-table td {
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 15px;
            text-align: center;
        }

        .question-table th {
            background: rgba(255, 255, 255, 0.2);
            font-weight: bold;
        }

        .question-table .theme-cell {
            background: rgba(255, 255, 255, 0.15);
            font-weight: bold;
            text-align: left;
        }

        .question-table .question-cell {
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            font-size: 18px;
            font-weight: bold;
        }

        .question-table .question-cell:hover:not(.answered):not(.disabled) {
            background: rgba(255, 255, 255, 0.3);
        }

        .question-table .question-cell.clickable {
            cursor: pointer;
        }

        .question-table .question-cell.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .question-table .question-cell.answered {
            visibility: hidden;
        }

        .question-table .question-cell.selected,
        .question-table .question-cell.disabled.selected {
            animation: blink 0.2s infinite;
            opacity: 1;
        }

        @keyframes blink {
            0%, 100% { background: rgba(255, 255, 255, 0.3); }
            50% { background: rgba(181, 244, 255, 0.8); }
        }

        /* Медиа контент */
        .media-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }

        .media-text {
            font-size: 24px;
            text-align: center;
            padding: 20px;
            max-width: 80%;
        }

        .media-text.karaoke {
            --duration: 3s;
            background: linear-gradient(90deg, #ffffff11 0%, #ffffff11 100%) 0 0 / 100% 0% no-repeat;
            animation: karaoke var(--duration) linear forwards;
        }

        @keyframes karaoke {
            0% {
                background-size: 100% 0%;
            }
            99.9% {
                background-size: 100% 100%;
            }
            100% {
                background-size: 100% 0%;
            }
        }

        .media-image {
            width: auto;
            height: auto;
            max-width: 90%;
            max-height: 80%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .media-video {
            max-width: 90%;
            max-height: 80%;
            border-radius: 10px;
        }

        .media-audio {
            font-size: 64px;
            width: auto;
            /*animation: pulse 2s infinite;*/
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .progress-bar {
            width: 80%;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            overflow: hidden;
            margin-top: 20px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 100%;
            transition: width 0.1s linear;
        }

        .progress-bar-fill.frozen {
            background: linear-gradient(90deg, #FF9800, #FFC107);
        }

        /* Правая зона - лог */
        .log-zone {
            display: none;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .log-entry {
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 12px;
            word-wrap: break-word;
        }

        .answer-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            background: #ff4949;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .answer-button:not(:disabled) {
            outline: 10px solid white;
        }

        .answer-button:hover:not(:disabled) {
            background: #ff4949;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .answer-button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Нижняя зона - игроки */
        .players-zone {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            gap: 15px;
            justify-content: center;
            max-height: 30vh;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 10px;
            min-width: 150px;
            max-width: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .player-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #fff;
            object-fit: cover;
        }

        .player-name {
            font-size: 14px;
            font-weight: bold;
            text-align: center;
        }

        .player-score {
            font-size: 20px;
            font-weight: bold;
            color: #FFD700;
        }

        .player-progress {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .player-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.1s linear;
        }

        .player-progress-fill.frozen {
            background: linear-gradient(90deg, #FF9800, #FFC107);
        }

        .player-bubble {    
            --duration: 5s;
            
            position: absolute;
            display: none;
            bottom: 100%;
            transform: translateY(40px);
            text-align: center;
            background: rgba(255, 255, 255, 0.7);
            color: #333;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            min-height: 30px;
            width: 80%;
            word-wrap: break-word;            
            animation: player-bubble-float var(--duration) linear forwards;
        }

        .player-bubble.fly {  
            opacity: 1;
            display: block;
            animation: player-bubble-float var(--duration) linear forwards; 
        } 

        @keyframes player-bubble-float {
            0% {
                transform: translateY(50px);
                opacity: 1;
            }
            50% {
                transform: translateY(0px);
                opacity: 0.9;
            }
            100% {
                transform: translateY(-50px);
                opacity: 0;
            }
        }

        .player-answer-window {
            position: absolute;
            top: -80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-radius: 10px;
            width: 250px;
            display: none;
            z-index: 100;
        }

        .player-answer-window.visible {
            display: block;
        }

        .player-answer-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 2px solid #4CAF50;
            border-radius: 5px;
            font-size: 14px;
        }

        .player-answer-submit {
            width: 100%;
            padding: 8px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .player-answer-submit:hover {
            background: #45a049;
        }

        .loading {
            text-align: center;
            font-size: 24px;
            padding: 50px;
        }

        .disabled-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .disabled-overlay.visible {
            display: flex;
        }

        .current-player{
            outline: 2px solid white;
            background-size: 30px 30px;
            background-image: linear-gradient(45deg, rgba(0, 0, 0, 0.1) 25%, transparent 25%, transparent 50%, rgba(0, 0, 0, 0.1) 50%, rgba(0, 0, 0, 0.1) 75%, transparent 75%, transparent);
            animation: barberpole 0.5s linear infinite;
        }

        @keyframes barberpole {
            from {
                background-position: 0 0;
            }
            to {
                background-position: 60px 30px;
            }
        }
    </style>
</head>
<body>
    <div class="disabled-overlay" id="disabledOverlay">
        <div>Загрузка медиа...</div>
    </div>

    <div class="container">
        <!-- Левая зона - ведущий -->
        <div class="host-zone">
            <img src="" alt="Ведущий" class="host-photo" id="hostPhoto">
            <div class="host-name" id="hostName">Дональд Трамп</div>
            <div class="host-bubble" id="hostBubble"></div>
        </div>

        <!-- Центральная зона -->
        <div class="center-zone" id="centerZone">
            <div class="loading">Загрузка...</div>
        </div>

        <!-- Правая зона - лог -->
        <div class="log-zone" id="logZone">Доска профессионализма:<br></div>
    </div>

    <!-- Кнопка ответить -->
    <button class="answer-button" id="answerButton" disabled>Ответить</button>

    <!-- Нижняя зона - игроки -->
    <div class="players-zone" id="playersZone"></div>

<script>
        const HOST_ADDRESS = "{{ .host }}";

        // Глобальные переменные
        const urlParams = new URLSearchParams(window.location.search);
        const playerId = parseInt(urlParams.get('id')) || 1;
        
        // Словари для медиа файлов
        let files = {}; // path: Blob
        let urls = {};  // path: URL string

        // Состояние игры
        let gameData = {
            packageJson: null,
            players: [],
            mediaZip: null,
            currentPlayerId: null,
            answeredQuestions: new Set(),
            selectedQuestionId: null,
            /*canAnswerTime: null,
            answerTimer: null,
            progressTimer: null,
            questionStartTime: null,
            questionDuration: 60000,*/
            ws: null,
            questionTimer: {
                duration: 10000,
                remains: 0,
                running: false,
                lastTimestamp: 0
            }
            //questionsCache: null,
        };

        setInterval(questionTimerStep, 25)

        // Инициализация
        async function init() {
            document.getElementById('disabledOverlay').classList.add('visible');
            
            try {
                // Загружаем данные
                await Promise.all([
                    loadData(),
                    loadMedia()
                ]);
                
                // Подключаемся к WebSocket
                connectWebSocket();
                
                document.getElementById('disabledOverlay').classList.remove('visible');
            } catch (error) {
                console.error('Ошибка инициализации:', error);
                addLog('Ошибка загрузки данных');
            }

            document.querySelector('.host-photo').setAttribute('src', getPlayerAvatar(1000))
        }

        // Загрузка данных
        async function loadData() {
            const response = await fetch(`data`);
            const data = await response.json();
            gameData.packageJson = data.packageJson;
            gameData.players = data.players;
            gameData.questionsCache = null; // Сброс кэша при новой загрузке
            
            // Update host name from player data (host has ID 1000)
            const hostPlayer = gameData.players.find(p => p.id === 1000);
            if (hostPlayer) {
                document.getElementById('hostName').textContent = hostPlayer.name;
            }
            
            updatePlayers();
        }

        // Загрузка медиа
        async function loadMedia() {
            const response = await fetch(`media`);
            const zipBlob = await response.blob();
            gameData.mediaZip = await processZip(zipBlob);
        }

        // Обработка сообщения start от сервера
        async function handleStart() {
            addLog('Начало игры - загрузка ресурсов...');
            
            try {
                // Загружаем данные и медиа
                await Promise.all([
                    loadData(),
                    loadMedia()
                ]);
                
                // Обновляем панель ведущего
                document.querySelector('.host-photo').setAttribute('src', getPlayerAvatar(1000));
                updatePlayers();
                
                // Отправляем подтверждение
                const formData = new URLSearchParams();
                formData.append('id', playerId);
                
                await fetch(`startacknowledge`, {
                    method: 'POST',
                    body: formData
                });
                
                addLog('Подтверждение начала игры отправлено');
            } catch (error) {
                console.error('Ошибка при обработке начала игры:', error);
                addLog('Ошибка при обработке начала игры');
            }
        }

        // Обработка ZIP
        async function processZip(file) {
            const zip = await JSZip.loadAsync(file);
            
            files = {};
            urls = {};

            for (const [rawPath, zipFile] of Object.entries(zip.files)) {

                const path = rawPath.replace(/\\/g, "/");

                if (!zipFile.dir) {
                    const blob = await zipFile.async('blob');
                    files[path] = blob;
                    urls[path] = URL.createObjectURL(blob);
                }
            }

            return zip;
        }


        // Функция для сопоставления медиа из вопроса с ZIP
        function getMediaUrl(mediaPath) {
            if (!mediaPath) return null;
            
            // Ищем файл в словаре urls (может быть в разных папках)
            const normalizedPath = mediaPath.replace(/^@/, '').replace(/\\/g, '/');
            
            // Пробуем разные варианты путей
            const possiblePaths = [
                `questions/${normalizedPath}`,
                `questions/Audio/${normalizedPath}`,
                `questions/Images/${normalizedPath}`,
                `questions/Video/${normalizedPath}`,
                normalizedPath,
                `Audio/${normalizedPath}`,
                `Images/${normalizedPath}`,
                `Video/${normalizedPath}`
            ];

            for (const path of possiblePaths) {
                if (urls[path]) {
                    return urls[path];
                }
            }
            
            return null;
        }

        // Функция для сопоставления ID игрока с аватаркой
        function getPlayerAvatar(playerId) {
            // Пробуем разные расширения
            const extensions = ['.jpg', '.jpeg', '.png', '.gif'];
            for (const ext of extensions) {
                const path = `players/${playerId}${ext}`;
                if (urls[path]) {
                    return urls[path];
                }
            }
            
            return null;
        }

        // Обновление списка игроков
        function updatePlayers() {
            const playersZone = document.getElementById('playersZone');
            playersZone.innerHTML = '';
            
            gameData.players.filter(x => x.id < 1000).slice(0, 5).forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                playerCard.id = `player-${player.id}`;
                playerCard.setAttribute('data-id', player.id);
                
                const avatarUrl = getPlayerAvatar(player.id) || '';
                
                playerCard.innerHTML = `
                    <img src="${avatarUrl}" alt="${player.name}" class="player-photo" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27100%27 height=%27100%27%3E%3Crect width=%27100%27 height=%27100%27 fill=%27%23ccc%27/%3E%3Ctext x=%2750%27 y=%2750%27 text-anchor=%27middle%27 dy=%27.3em%27 fill=%27%23999%27%3E${player.name[0]}%3C/text%3E%3C/svg%3E'">
                    <div class="player-name">${player.name}</div>
                    <div class="player-score" id="score-${player.id}">0</div>
                    <div class="player-progress">
                        <div class="player-progress-fill" id="progress-${player.id}"></div>
                    </div>
                    <div class="player-bubble" id="bubble-${player.id}"></div>
                    <div class="player-answer-window" id="answer-window-${player.id}">
                        <input type="text" class="player-answer-input" id="answer-input-${player.id}" placeholder="Ваш ответ" onkeypress="if(event.key==='Enter') submitAnswer(${player.id})">
                        <button class="player-answer-submit" onclick="submitAnswer(${player.id})">Отправить</button>
                    </div>
                `;
                
                playersZone.appendChild(playerCard);
            });
            
            updateScores();
        }

        // Обновление очков
        async function updateScores() {
            try {
                const response = await fetch(`scores`);
                const scores = await response.json();
                
                scores.forEach(score => {
                    const scoreEl = document.getElementById(`score-${score.id}`);
                    if (scoreEl) {
                        scoreEl.textContent = score.score;
                    }
                });
            } catch (error) {
                console.error('Ошибка обновления очков:', error);
            }
        }

        // Подключение к WebSocket
        function connectWebSocket() {
            const wsUrl = HOST_ADDRESS.replace('http', 'ws');
            gameData.ws = new WebSocket(`${wsUrl}/ws`);
            
            gameData.ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };
            
            gameData.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                addLog('Ошибка подключения');
            };
            
            gameData.ws.onclose = () => {
                addLog('Соединение закрыто');
                setTimeout(connectWebSocket, 3000);
            };
        }

        // Обработка сообщений WebSocket
        function handleWebSocketMessage(message) {
            addLog(`Получено: ${message.type}`);
            
            switch (message.type) {
                case 'start': 
                    handleStart();
                    break;
                case 'questionstable':
                    handleMainTable(message.table);
                    break;
                case 'questionselected':
                    handleQuestionSelected(message.id);
                    break;
                case 'showquestion':
                    handleShowQuestion(message.id, message.time);
                    break;
                case 'cananswer':
                    handleCanAnswer(message.timestamp);
                    break;
                case 'waitanswer':
                    handleWaitAnswer(message.playerId);
                    break;
                case 'stoptimer':
                    handleStopTimer();
                    break;
                case 'validated':
                    handleValidated(message.idQuest, message.playerId, message.result, message.unfreeze);
                    break;
                case 'showanswer':
                    handleShowAnswer(message.idQuest);
                    break;
                case 'hosttalk':
                    hostTalk(message.text);
                    break;
                case 'playertalk':
                    playerTalk(message.playerId, message.text);
                    break;
            }
        }

        // Обработка maintable (questionstable)
        function handleMainTable(tableText) {
            redrawQuestionTable(tableText);
            checkCurrentPlayer();
        }

        // Перерисовка таблицы вопросов
        async function redrawQuestionTable(str) {
            const response = await fetch(`currentround`);
            const roundNum = parseInt(await response.text());

            const centerZone = document.getElementById('centerZone');
            centerZone.className = 'center-zone';
            
            const parts = str.split("|");

            const rows = [];
            let current = [];

            for (const part of parts) {
                if (part === "") {
                    continue;
                }

                // already answered question
                if (part === "-") {
                    current.push(part);
                    continue;
                }
                
                // A new theme starts whenever the current row already has content
                // and this part is NOT a question (i.e., first item after completing row)
                if (current.length > 0 && isNaN(part)) {
                    rows.push(current);
                    current = [];
                }
                
                current.push(part);
            }
            if (current.length > 0) rows.push(current);

            // Find maximum number of columns
            const maxCols = Math.max(...rows.map(r => r.length));

            // Pad rows to max length
            rows.forEach(r => {
                while (r.length < maxCols) r.push("");
            });

            // Build HTML table
            let html = "<table border='1' class='question-table'>\n";
            rows.forEach((row, row_i) => {
                html += "  <tr>" + row.map((cell, i) => {
                    let r = roundNum;
                    let t = row_i+1;
                    let q = i;
                    let onclick = `selectQuestion(${r}, ${t}, ${q})`
                    let baseClass = i ? 'question-cell' : 'theme-cell';
                    let stringId = i ? 'question-cell-' + getQuestionId(r, t, q) : '';
                    if (cell === "-") {
                        return `<td class='${baseClass} answered'></td>`
                    } else {
                        return `<td class='${baseClass} ${stringId}' onclick="${onclick}">${cell}</td>`
                    }
                }).join("") + "</tr>\n";
            });
            html += "</table>";

            centerZone.innerHTML = html;
        }

        // Проверка текущего игрока
        async function checkCurrentPlayer() {
            try {
                const response = await fetch(`currentplayer`);
                const currentPlayerId = parseInt(await response.text());
                gameData.currentPlayerId = currentPlayerId;
                $(`.player-card`).removeClass('current-player');
                $(`#player-${currentPlayerId}`).addClass('current-player');
                
                if (currentPlayerId === playerId) {
                    enableQuestionButtons();
                } else {
                    disableQuestionButtons();
                }
            } catch (error) {
                console.error('Ошибка проверки текущего игрока:', error);
            }
        }

        // Включение кнопок вопросов
        function enableQuestionButtons() {
            document.querySelectorAll('.question-cell').forEach(cell => {
                if (!cell.classList.contains('answered')) {
                    cell.classList.add('clickable');
                    cell.classList.remove('disabled');
                }
            });
        }

        // Отключение кнопок вопросов
        function disableQuestionButtons() {
            document.querySelectorAll('.question-cell').forEach(cell => {
                cell.classList.remove('clickable');
                cell.classList.add('disabled');
            });
        }

        function getQuestionId(roundNum, themeNum, questionNum) {
            return `${roundNum}_${themeNum}_${questionNum}`
        }

        async function HighlightQuestionForSeconds(questionStringId, sec) {
            const cell = $(`.question-cell-${questionStringId}`)
            cell.addClass('selected')
            return new Promise(resolve => 
                setTimeout(() => {  
                    cell.removeClass('selected')
                    resolve()
                }, sec * 1000)
            )
        }

        // Выбор вопроса
        async function selectQuestion(roundNum, themeNum, questionNum) {
            gameData.selectedQuestionId = getQuestionId(roundNum, themeNum, questionNum);
            const cell = $(`.question-cell-${getQuestionId(roundNum, themeNum, questionNum)}`)
            if (cell.hasClass('disabled')) {
                console.log('cant')
                return;
            }

            disableQuestionButtons();

            const formData = new URLSearchParams();
            formData.append('round', roundNum);
            formData.append('theme', themeNum);
            formData.append('question', questionNum);
            formData.append('player', playerId);

            await fetch(`selectquestion`, {
                method: 'POST',
                body: formData
            });
        }

        // Обработка questionselected
        async function handleQuestionSelected(questionId) {
            gameData.selectedQuestionId = questionId;
            $(`.player-card`).removeClass('current-player');
            await HighlightQuestionForSeconds(questionId, 1)
            await showQuestion(questionId);
            runAnswerTimer(10);
        }

        // Обработка showquestion
        async function handleShowQuestion(questionId) {

        }

        // Показ вопроса
        async function showQuestion(questionId) {
            const parts = questionId.split('_')
            const r = +parts[0]-1
            const t = +parts[1]-1
            const q = +parts[2]-1

            const question = gameData.packageJson['rounds'][0]['round'][r]['themes'][0]['theme'][t]['questions'][0]['question'][q]
            const content = question['params'][0]['param'].find(x => x['@name'] == 'question')['item']

            for (let stage of content) {
                if (!stage['@type']) {
                    await showTextMedia(stage, content.length > 1, true);
                }
                if (stage['@type'] === "image") {
                    await showImageMedia(stage);
                }
                if (stage['@type'] === "audio") {
                    await showAudioMedia(stage);
                }
                if (stage['@type'] === "video") {
                    await showVideoMedia(stage);
                }
            }
        }

        async function showAnswer(questionId) {
            const parts = questionId.split('_')
            const r = +parts[0]-1
            const t = +parts[1]-1
            const q = +parts[2]-1

            const question = gameData.packageJson['rounds'][0]['round'][r]['themes'][0]['theme'][t]['questions'][0]['question'][q]
            const content = question['right'][0]['answer']

            for (let stage of content) {
                if (!stage['@type']) {
                    await showTextMedia(stage, content.length > 1, false);
                }
                if (stage['@type'] === "image") {
                    await showImageMedia(stage);
                }
                if (stage['@type'] === "audio") {
                    await showAudioMedia(stage);
                }
                if (stage['@type'] === "video") {
                    await showVideoMedia(stage);
                }
            }
        }

        async function showTextMedia(data, short, karaoke) {
            let text = data['#text'];
            let label = $('<div>').text(text).addClass('media-text media-content')
            let time = Math.round((short ? 3000 : 3000 + text.length * 40) / 1000) * 1000 + 1000;
            $('#centerZone').html('').append(label)
            if (karaoke) {
                $(label).css('--duration', Math.round(time / 1000) + 's');
                $(label).addClass('karaoke');
            }
            return new Promise(resolve => setTimeout(() => {
                $(label).removeClass('karaoke');
                resolve()

            }, time))
        }

        async function showImageMedia(data) {
            let name = data['#text'];
            let url = urls[`questions/Images/${name}`]
            let img = $('<img>').attr('src', url).addClass('media-image media-content')
            $('#centerZone').html('').append(img)
            return new Promise(resolve => setTimeout(resolve, 6000))
        }

        async function showAudioMedia(data) {
            let name = data['#text'];
            let url = urls[`questions/Audio/${name}`]
            let img = $('<img>').attr('src', `client/music.gif`).addClass('media-audio media-content')
            $('#centerZone').html('').append(img)
            return new Promise((resolve, reject) => {
                const audio = new Audio(url);
                audio.loop = false;

                audio.addEventListener("ended", () => resolve());
                audio.addEventListener("error", err => reject(err));

                audio.play().catch(reject);
            });
        }

        async function showVideoMedia(data) {
            let name = data['#text'];
            let url = urls[`questions/Video/${name}`];

            const container = $('#centerZone');
            const video = $('<video>').addClass('media-video media-content')
                .attr('src', url)
                .attr('controls', false)    // optional
                .attr('autoplay', true)    // start immediately
                .attr('loop', false)       // play only once
                .attr('playsInline', true) // needed for mobile (iOS)
            $('#centerZone').html('').append(video);

            return new Promise(resolve => {
                video.on('ended', resolve);
            })
        }

        // Поиск вопроса по ID
        function findQuestionById(questionId) {
            if (!gameData.packageJson || !gameData.packageJson.rounds) return null;
            
            // Используем кэш вопросов для быстрого поиска
            if (!gameData.questionsCache) {
                gameData.questionsCache = new Map();
                buildQuestionsCache();
            }
            
            return gameData.questionsCache.get(questionId) || null;
        }

        // Построение кэша вопросов
        function buildQuestionsCache() {
            gameData.questionsCache = new Map();
            let questionCounter = 1;
            
            if (!gameData.packageJson || !gameData.packageJson.rounds) return;
            
            // Новая структура: rounds -> round[] -> themes -> theme[] -> questions -> question[]
            for (const round of gameData.packageJson.rounds) {
                if (!round || !round.round) continue;
                
                const roundArray = Array.isArray(round.round) ? round.round : [round.round];
                for (const roundItem of roundArray) {
                    if (!roundItem || !roundItem.themes) continue;
                    
                    const themes = Array.isArray(roundItem.themes) ? roundItem.themes : [roundItem.themes];
                    for (const themeData of themes) {
                        if (!themeData || !themeData.theme) continue;
                        
                        const themeArray = Array.isArray(themeData.theme) ? themeData.theme : [themeData.theme];
                        for (const theme of themeArray) {
                            if (!theme || !theme.questions) continue;
                            
                            const questions = Array.isArray(theme.questions) ? theme.questions : [theme.questions];
                            for (const qData of questions) {
                                if (!qData || !qData.question) continue;
                                
                                const questionArray = Array.isArray(qData.question) ? qData.question : [qData.question];
                                for (const q of questionArray) {
                                    if (!q) continue;
                                    
                                    // Используем счетчик для генерации ID (как на сервере)
                                    const idNum = questionCounter++;
                                    gameData.questionsCache.set(idNum, q);
                                }
                            }
                        }
                    }
                }
            }
        }

        // Обработка cananswer
        function handleCanAnswer(timestamp) {
            /*gameData.canAnswerTime = timestamp;
            const delay = timestamp - Date.now();
            
            if (delay > 0) {
                setTimeout(() => {
                    enableAnswerButton();
                    startAnswerTimer();
                }, delay);
            } else {
                enableAnswerButton();
                startAnswerTimer();
            }*/
        }

        // Включение кнопки ответить
        function enableAnswerButton() {
            const button = document.getElementById('answerButton');
            button.disabled = false;
        }

        // Отключение кнопки ответить
        function disableAnswerButton() {
            const button = document.getElementById('answerButton');
            button.disabled = true;
        }

        function questionTimerStep() {
            if (!gameData.questionTimer.running) {
                return;
            }
            if (gameData.questionTimer.remains <= 0) {
                stopAnswerTimer()
                
                const formData = new URLSearchParams();
                formData.append('id-player', playerId);
                fetch(`timerdone`, {
                    method: 'POST',
                    body: formData
                });
            }
            gameData.questionTimer.remains -= +new Date() - gameData.questionTimer.lastTimestamp;
            gameData.questionTimer.lastTimestamp = +new Date()
            let progress = (gameData.questionTimer.remains / gameData.questionTimer.duration) * 100;
            $('.container').css('background', `linear-gradient(90deg, #8BC34A 0%, #8BC34A 100%) 0 0 / ${progress}% 100% no-repeat, linear-gradient(135deg, #667eea 0%, #764ba2 100%)`)
        }

        // Запуск таймера ответа
        function runAnswerTimer(sec) {
            gameData.questionTimer.duration = sec * 1000;
            gameData.questionTimer.remains = sec * 1000;
            gameData.questionTimer.running = true;
            gameData.questionTimer.lastTimestamp = +new Date();
            enableAnswerButton()
        }

        function stopAnswerTimer() {
            gameData.questionTimer.running = false;
            $('.container').css('background', `linear-gradient(135deg, #667eea 0%, #764ba2 100%)`)
            disableAnswerButton()
        }

        // Заморозка таймера
        function freezeTimer() {
            gameData.questionTimer.running = false;
        }

        // Разморозка таймера
        function unfreezeTimer() {
            gameData.questionTimer.running = true;
            gameData.questionTimer.lastTimestamp = +new Date()
        }

        // Обработка waitanswer
        function handleWaitAnswer(waitingPlayerId) {
            freezeTimer();
            disableAnswerButton()
            $(`.player-card`).removeClass('current-player');
            $(`#player-${waitingPlayerId}`).addClass('current-player');
            
            if (waitingPlayerId === playerId) {
                showAnswerWindow();
            }
        }

        // Показ окна ответа
        function showAnswerWindow() {
            const window = document.getElementById(`answer-window-${playerId}`);
            if (window) {
                window.classList.add('visible');
                const input = document.getElementById(`answer-input-${playerId}`);
                if (input) input.focus();
            }
        }

        // Скрытие окна ответа
        function hideAnswerWindow() {
            const window = document.getElementById(`answer-window-${playerId}`);
            if (window) {
                window.classList.remove('visible');
            }
        }

        // Отправка ответа
        async function submitAnswer(playerId) {
            const input = document.getElementById(`answer-input-${playerId}`);
            const answerText = input ? input.value.trim() : '';
            
            if (!answerText) return; // Не отправляем пустой ответ
            
            hideAnswerWindow();
            
            if (input) {
                input.value = ''; // Очищаем поле
            }
            
            try {
                const formData = new URLSearchParams();
                formData.append('id-quest', gameData.selectedQuestionId);
                formData.append('id-player', playerId);
                formData.append('text', answerText);
                
                await fetch(`answer`, {
                    method: 'POST',
                    body: formData
                });
            } catch (error) {
                console.error('Ошибка отправки ответа:', error);
            }
        }

        function handleStopTimer() {
            freezeTimer();
        }

        // Обработка validated
        function handleValidated(idQuest, idPlayer, result, unfreeze) {
            if (unfreeze) {
                unfreezeTimer()
            }
            if (!gameData.answeredQuestions.has(idQuest)) {
                gameData.answeredQuestions.add(idQuest);
                if (idPlayer !== playerId) {
                    enableAnswerButton();
                }
            }
            setTimeout(updateScores, 1000);
        }

        // Обработка showanswer
        async function handleShowAnswer(questId) {
            showAnswer(questId)
            stopAnswerTimer();
        }

        // Поиск ответа по ID вопроса
        function findAnswerById(questionId) {

        }

        // Отображение ответа
        async function displayAnswer(mediaItems) {

        }

        // Реплика ведущего
        function hostTalk(text) {
            document.getElementById('hostBubble').textContent = text;
            addLog(`Ведущий: ${text}`);
        }

        // Реплика игрока
        function playerTalk(playerId, text) {
            const bubble = $(`#bubble-${playerId}`);
            if (bubble) {
                $(bubble).text(text);
                $(bubble).addClass('fly');
                setTimeout(() => $(bubble).removeClass('fly'), 5000)
            }

            addLog(`Игрок ${playerId}: ${text}`);
        }

        // Добавление в лог
        function addLog(message) {
            const logZone = document.getElementById('logZone');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logZone.appendChild(entry);
            logZone.scrollTop = logZone.scrollHeight;
        }

        async function answerButtonClicked() {
            const button = document.getElementById('answerButton');
            if (button.disabled) return;
            
            disableAnswerButton();
            freezeTimer();
            
            try {
                const formData = new URLSearchParams();
                formData.append('player', playerId);
                formData.append('timestamp', Date.now().toString());
                
                await fetch(`requestanswer`, {
                    method: 'POST',
                    body: formData
                });
            } catch (error) {
                console.error('Ошибка requestanswer:', error);
            }
        }

        // Обработка кнопки ответить
        document.getElementById('answerButton').addEventListener('click', answerButtonClicked);
        document.addEventListener('keydown', (e) => {
            if ($('#answerButton')[0].disabled) {
                return true;
            }
            if (e.code === 'Space') {
                e.preventDefault();
                answerButtonClicked();
            }
        });

        // Инициализация при загрузке
        window.addEventListener('load', init);
    </script>

    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
</body>
</html>
