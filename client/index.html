<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–≥—Ä–∞</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        .container {
            display: grid;
            grid-template-columns: 200px 1fr 300px;
            grid-template-rows: 1fr auto;
            height: 70vh;
            gap: 10px;
            padding: 10px;
        }

        /* –õ–µ–≤–∞—è –∑–æ–Ω–∞ - –≤–µ–¥—É—â–∏–π */
        .host-zone {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .host-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid #fff;
            object-fit: cover;
        }

        .host-name {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }

        .host-bubble {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 10px 15px;
            border-radius: 15px;
            min-height: 50px;
            width: 100%;
            font-size: 14px;
            word-wrap: break-word;
        }

        /* –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞ */
        .center-zone {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .center-zone.hidden {
            display: none;
        }

        /* –¢–∞–±–ª–∏—Ü–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ */
        .question-table {
            width: 100%;
            height: 100%;
            border-collapse: collapse;
        }

        .question-table th,
        .question-table td {
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 15px;
            text-align: center;
        }

        .question-table th {
            background: rgba(255, 255, 255, 0.2);
            font-weight: bold;
        }

        .question-table .theme-cell {
            background: rgba(255, 255, 255, 0.15);
            font-weight: bold;
            text-align: left;
        }

        .question-table .question-cell {
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            font-size: 18px;
            font-weight: bold;
        }

        .question-table .question-cell:hover:not(.answered):not(.disabled) {
            background: rgba(255, 255, 255, 0.3);
        }

        .question-table .question-cell.clickable {
            cursor: pointer;
        }

        .question-table .question-cell.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .question-table .question-cell.answered {
            visibility: hidden;
        }

        .question-table .question-cell.selected {
            animation: blink 0.5s infinite;
        }

        @keyframes blink {
            0%, 100% { background: rgba(255, 255, 255, 0.3); }
            50% { background: rgba(255, 215, 0, 0.8); }
        }

        /* –ú–µ–¥–∏–∞ –∫–æ–Ω—Ç–µ–Ω—Ç */
        .media-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }

        .media-text {
            font-size: 24px;
            text-align: center;
            padding: 20px;
            max-width: 80%;
        }

        .media-image {
            max-width: 90%;
            max-height: 80%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .media-video {
            max-width: 90%;
            max-height: 80%;
            border-radius: 10px;
        }

        .media-audio {
            font-size: 64px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .progress-bar {
            width: 80%;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            overflow: hidden;
            margin-top: 20px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 100%;
            transition: width 0.1s linear;
        }

        .progress-bar-fill.frozen {
            background: linear-gradient(90deg, #FF9800, #FFC107);
        }

        /* –ü—Ä–∞–≤–∞—è –∑–æ–Ω–∞ - –ª–æ–≥ */
        .log-zone {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .log-entry {
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 12px;
            word-wrap: break-word;
        }

        .answer-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .answer-button:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .answer-button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* –ù–∏–∂–Ω—è—è –∑–æ–Ω–∞ - –∏–≥—Ä–æ–∫–∏ */
        .players-zone {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            gap: 15px;
            justify-content: center;
            max-height: 30vh;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 10px;
            min-width: 150px;
            max-width: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .player-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #fff;
            object-fit: cover;
        }

        .player-name {
            font-size: 14px;
            font-weight: bold;
            text-align: center;
        }

        .player-score {
            font-size: 20px;
            font-weight: bold;
            color: #FFD700;
        }

        .player-progress {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .player-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.1s linear;
        }

        .player-progress-fill.frozen {
            background: linear-gradient(90deg, #FF9800, #FFC107);
        }

        .player-bubble {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            min-height: 30px;
            width: 100%;
            word-wrap: break-word;
        }

        .player-answer-window {
            position: absolute;
            top: -80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-radius: 10px;
            width: 250px;
            display: none;
            z-index: 100;
        }

        .player-answer-window.visible {
            display: block;
        }

        .player-answer-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 2px solid #4CAF50;
            border-radius: 5px;
            font-size: 14px;
        }

        .player-answer-submit {
            width: 100%;
            padding: 8px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .player-answer-submit:hover {
            background: #45a049;
        }

        .loading {
            text-align: center;
            font-size: 24px;
            padding: 50px;
        }

        .disabled-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .disabled-overlay.visible {
            display: flex;
        }

        .current-player{
            outline: 2px solid white;
            background-size: 30px 30px;
            background-image: linear-gradient(45deg, rgba(0, 0, 0, 0.1) 25%, transparent 25%, transparent 50%, rgba(0, 0, 0, 0.1) 50%, rgba(0, 0, 0, 0.1) 75%, transparent 75%, transparent);
            animation: barberpole 0.5s linear infinite;
        }

        @keyframes barberpole {
            from {
                background-position: 0 0;
            }
            to {
                background-position: 60px 30px;
            }
        }
    </style>
</head>
<body>
    <div class="disabled-overlay" id="disabledOverlay">
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞...</div>
    </div>

    <div class="container">
        <!-- –õ–µ–≤–∞—è –∑–æ–Ω–∞ - –≤–µ–¥—É—â–∏–π -->
        <div class="host-zone">
            <img src="" alt="–í–µ–¥—É—â–∏–π" class="host-photo" id="hostPhoto">
            <div class="host-name" id="hostName">–í–µ–¥—É—â–∏–π</div>
            <div class="host-bubble" id="hostBubble"></div>
        </div>

        <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞ -->
        <div class="center-zone" id="centerZone">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∑–æ–Ω–∞ - –ª–æ–≥ -->
        <div class="log-zone" id="logZone"></div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–≤–µ—Ç–∏—Ç—å -->
    <button class="answer-button" id="answerButton" disabled>–û—Ç–≤–µ—Ç–∏—Ç—å</button>

    <!-- –ù–∏–∂–Ω—è—è –∑–æ–Ω–∞ - –∏–≥—Ä–æ–∫–∏ -->
    <div class="players-zone" id="playersZone"></div>

<script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        const urlParams = new URLSearchParams(window.location.search);
        const playerId = parseInt(urlParams.get('id')) || 1;
        
        // –°–ª–æ–≤–∞—Ä–∏ –¥–ª—è –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤
        let files = {}; // path: Blob
        let urls = {};  // path: URL string
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è URL —Å–µ—Ä–≤–µ—Ä–∞
        function getServerUrl() {
            return 'http://localhost:8080';
        }

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let gameData = {
            packageJson: null,
            players: [],
            mediaZip: null,
            currentPlayerId: null,
            answeredQuestions: new Set(),
            selectedQuestionId: null,
            canAnswerTime: null,
            answerTimer: null,
            progressTimer: null,
            questionStartTime: null,
            questionDuration: 60000, // 60 —Å–µ–∫—É–Ω–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            ws: null,
            questionsCache: null
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            document.getElementById('disabledOverlay').classList.add('visible');
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                await Promise.all([
                    loadData(),
                    loadMedia()
                ]);
                
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket
                connectWebSocket();
                
                document.getElementById('disabledOverlay').classList.remove('visible');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                addLog('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }

            document.querySelector('.host-photo').setAttribute('src', getPlayerAvatar(1000))
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function loadData() {
            const response = await fetch(`${getServerUrl()}/data`);
            const data = await response.json();
            gameData.packageJson = data.packageJson;
            gameData.players = data.players;
            gameData.questionsCache = null; // –°–±—Ä–æ—Å –∫—ç—à–∞ –ø—Ä–∏ –Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
            updatePlayers();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞
        async function loadMedia() {
            const response = await fetch(`${getServerUrl()}/media`);
            const zipBlob = await response.blob();
            gameData.mediaZip = await processZip(zipBlob);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è start –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        async function handleStart() {
            addLog('–ù–∞—á–∞–ª–æ –∏–≥—Ä—ã - –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤...');
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –º–µ–¥–∏–∞
                await Promise.all([
                    loadData(),
                    loadMedia()
                ]);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –≤–µ–¥—É—â–µ–≥–æ
                document.querySelector('.host-photo').setAttribute('src', getPlayerAvatar(1000));
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                const formData = new URLSearchParams();
                formData.append('id', playerId);
                
                await fetch(`${getServerUrl()}/startacknowledge`, {
                    method: 'POST',
                    body: formData
                });
                
                addLog('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã:', error);
                addLog('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ ZIP
        async function processZip(file) {
            const zip = await JSZip.loadAsync(file);
            
            files = {};
            urls = {};

            for (const [rawPath, zipFile] of Object.entries(zip.files)) {

                const path = rawPath.replace(/\\/g, "/");

                if (!zipFile.dir) {
                    const blob = await zipFile.async('blob');
                    files[path] = blob;
                    urls[path] = URL.createObjectURL(blob);
                }
            }

            return zip;
        }


        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –º–µ–¥–∏–∞ –∏–∑ –≤–æ–ø—Ä–æ—Å–∞ —Å ZIP
        function getMediaUrl(mediaPath) {
            if (!mediaPath) return null;
            
            // –ò—â–µ–º —Ñ–∞–π–ª –≤ —Å–ª–æ–≤–∞—Ä–µ urls (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö –ø–∞–ø–∫–∞—Ö)
            const normalizedPath = mediaPath.replace(/^@/, '').replace(/\\/g, '/');
            
            // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø—É—Ç–µ–π
            const possiblePaths = [
                `questions/${normalizedPath}`,
                `questions/Audio/${normalizedPath}`,
                `questions/Images/${normalizedPath}`,
                `questions/Video/${normalizedPath}`,
                normalizedPath,
                `Audio/${normalizedPath}`,
                `Images/${normalizedPath}`,
                `Video/${normalizedPath}`
            ];

            for (const path of possiblePaths) {
                if (urls[path]) {
                    return urls[path];
                }
            }
            
            return null;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è ID –∏–≥—Ä–æ–∫–∞ —Å –∞–≤–∞—Ç–∞—Ä–∫–æ–π
        function getPlayerAvatar(playerId) {
            // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
            const extensions = ['.jpg', '.jpeg', '.png', '.gif'];
            for (const ext of extensions) {
                const path = `players/${playerId}${ext}`;
                if (urls[path]) {
                    return urls[path];
                }
            }
            
            return null;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
        function updatePlayers() {
            const playersZone = document.getElementById('playersZone');
            playersZone.innerHTML = '';
            
            gameData.players.filter(x => x.id < 1000).slice(0, 5).forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                playerCard.id = `player-${player.id}`;
                playerCard.setAttribute('data-id', player.id);
                
                const avatarUrl = getPlayerAvatar(player.id) || '';
                
                playerCard.innerHTML = `
                    <img src="${avatarUrl}" alt="${player.name}" class="player-photo" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27100%27 height=%27100%27%3E%3Crect width=%27100%27 height=%27100%27 fill=%27%23ccc%27/%3E%3Ctext x=%2750%27 y=%2750%27 text-anchor=%27middle%27 dy=%27.3em%27 fill=%27%23999%27%3E${player.name[0]}%3C/text%3E%3C/svg%3E'">
                    <div class="player-name">${player.name}</div>
                    <div class="player-score" id="score-${player.id}">0</div>
                    <div class="player-progress">
                        <div class="player-progress-fill" id="progress-${player.id}"></div>
                    </div>
                    <div class="player-bubble" id="bubble-${player.id}"></div>
                    <div class="player-answer-window" id="answer-window-${player.id}">
                        <input type="text" class="player-answer-input" id="answer-input-${player.id}" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç" onkeypress="if(event.key==='Enter') submitAnswer(${player.id})">
                        <button class="player-answer-submit" onclick="submitAnswer(${player.id})">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                `;
                
                playersZone.appendChild(playerCard);
            });
            
            updateScores();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—á–∫–æ–≤
        async function updateScores() {
            try {
                const response = await fetch(`${getServerUrl()}/scores`);
                const scores = await response.json();
                
                scores.forEach(score => {
                    const scoreEl = document.getElementById(`score-${score.id}`);
                    if (scoreEl) {
                        scoreEl.textContent = score.score;
                    }
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—á–∫–æ–≤:', error);
            }
        }

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
        function connectWebSocket() {
            const wsUrl = getServerUrl().replace('http', 'ws');
            gameData.ws = new WebSocket(`${wsUrl}/ws`);
            
            gameData.ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };
            
            gameData.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                addLog('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            };
            
            gameData.ws.onclose = () => {
                addLog('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
                setTimeout(connectWebSocket, 3000);
            };
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π WebSocket
        function handleWebSocketMessage(message) {
            addLog(`–ü–æ–ª—É—á–µ–Ω–æ: ${message.type}`);
            
            switch (message.type) {
                case 'start': 
                    handleStart();
                    break;
                case 'questionstable':
                    handleMainTable(message.table);
                    break;
                case 'questionselected':
                    handleQuestionSelected(message.id);
                    break;
                case 'showquestion':
                    handleShowQuestion(message.id, message.time);
                    break;
                case 'cananswer':
                    handleCanAnswer(message.timestamp);
                    break;
                case 'waitanswer':
                    handleWaitAnswer(message.playerId);
                    break;
                case 'validated':
                    handleValidated(message.idQuest, message.idPlayer, message.result);
                    break;
                case 'showanswer':
                    handleShowAnswer(message.questId);
                    break;
                case 'showmantalk':
                    showmanTalk(message.text);
                    break;
                case 'playertalk':
                    playerTalk(message.playerId, message.text);
                    break;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ maintable (questionstable)
        function handleMainTable(tableText) {
            redrawQuestionTable(tableText);
            checkCurrentPlayer();
        }

        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –≤–æ–ø—Ä–æ—Å–æ–≤
        function redrawQuestionTable(str) {
            const centerZone = document.getElementById('centerZone');
            centerZone.className = 'center-zone';
            
            const parts = str.split("|");

            const rows = [];
            let current = [];

            for (const part of parts) {
                if (part === "") {
                    continue;
                }
                
                // A new theme starts whenever the current row already has content
                // and this part is NOT a question (i.e., first item after completing row)
                if (current.length > 0 && isNaN(part)) {
                    rows.push(current);
                    current = [];
                }
                
                current.push(part);
            }
            if (current.length > 0) rows.push(current);

            // Find maximum number of columns
            const maxCols = Math.max(...rows.map(r => r.length));

            // Pad rows to max length
            rows.forEach(r => {
                while (r.length < maxCols) r.push("");
            });

            // Build HTML table
            let html = "<table border='1' class='question-table'>\n";
            rows.forEach(row => {
                html += "  <tr>" + row.map((cell, i) => `<td class='${i ? 'question-cell' : 'theme-cell'}'>${cell}</td>`).join("") + "</tr>\n";
            });
            html += "</table>";

            centerZone.innerHTML = html;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
        async function checkCurrentPlayer() {
            try {
                const response = await fetch(`${getServerUrl()}/currentplayer`);
                const currentPlayerId = parseInt(await response.text());
                gameData.currentPlayerId = currentPlayerId;
                $(`.playerCard`).removeClass('current-player');
                $(`#player-${currentPlayerId}`).addClass('current-player');
                
                if (currentPlayerId === playerId) {
                    enableQuestionButtons();
                } else {
                    disableQuestionButtons();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞:', error);
            }
        }

        // –í–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤
        function enableQuestionButtons() {
            document.querySelectorAll('.question-cell').forEach(cell => {
                if (!cell.classList.contains('answered')) {
                    cell.classList.add('clickable');
                    cell.classList.remove('disabled');
                }
            });
        }

        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤
        function disableQuestionButtons() {
            document.querySelectorAll('.question-cell').forEach(cell => {
                cell.classList.remove('clickable');
                cell.classList.add('disabled');
            });
        }

        // –í—ã–±–æ—Ä –≤–æ–ø—Ä–æ—Å–∞
        async function selectQuestion(questionId) {
            disableQuestionButtons();
            gameData.selectedQuestionId = questionId;
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
            document.querySelectorAll('.question-cell').forEach(cell => {
                cell.classList.remove('selected');
                if (parseInt(cell.dataset.questionId) === questionId) {
                    cell.classList.add('selected');
                }
            });
            
            try {
                const formData = new URLSearchParams();
                formData.append('idQuest', questionId);
                formData.append('idPlayer', playerId);
                
                await fetch(`${getServerUrl()}/selectquestion`, {
                    method: 'POST',
                    body: formData
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –≤–æ–ø—Ä–æ—Å–∞:', error);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ questionselected
        function handleQuestionSelected(questionId) {
            document.getElementById('centerZone').classList.add('hidden');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ showquestion
        async function handleShowQuestion(questionId, startTime) {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º acknowledge
            try {
                const formData = new URLSearchParams();
                formData.append('id', playerId);
                await fetch(`${getServerUrl()}/acknowledge`, {
                    method: 'POST',
                    body: formData
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ acknowledge:', error);
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç
            const delay = startTime - Date.now();
            if (delay > 0) {
                setTimeout(() => {
                    showQuestion(questionId, 0);
                }, delay);
            } else {
                showQuestion(questionId, 0);
            }
        }

        // –ü–æ–∫–∞–∑ –≤–æ–ø—Ä–æ—Å–∞
        async function showQuestion(questionId, mediaIndex) {
            const centerZone = document.getElementById('centerZone');
            centerZone.classList.remove('hidden');
            
            // –ù–∞—Ö–æ–¥–∏–º –≤–æ–ø—Ä–æ—Å –≤ –¥–∞–Ω–Ω—ã—Ö
            const question = findQuestionById(questionId);
            if (!question) {
                centerZone.innerHTML = '<div class="loading">–í–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞
            const mediaItems = getQuestionMedia(question);
            
            if (mediaIndex < mediaItems.length) {
                const media = mediaItems[mediaIndex];
                displayMedia(media);
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –µ—â–µ –º–µ–¥–∏–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–µ–µ
                if (mediaIndex + 1 < mediaItems.length) {
                    setTimeout(() => {
                        showQuestion(questionId, mediaIndex + 1);
                    }, 2000); // 2 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –º–µ–¥–∏–∞
                } else {
                    // –í—Å–µ –º–µ–¥–∏–∞ –ø–æ–∫–∞–∑–∞–Ω—ã, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º questionbeenshown
                    try {
                        const formData = new URLSearchParams();
                        formData.append('playerId', playerId);
                        await fetch(`${getServerUrl()}/questionbeenshown`, {
                            method: 'POST',
                            body: formData
                        });
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ questionbeenshown:', error);
                    }
                }
            }
        }

        // –ü–æ–∏—Å–∫ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ ID
        function findQuestionById(questionId) {
            if (!gameData.packageJson || !gameData.packageJson.rounds) return null;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
            if (!gameData.questionsCache) {
                gameData.questionsCache = new Map();
                buildQuestionsCache();
            }
            
            return gameData.questionsCache.get(questionId) || null;
        }

        // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫—ç—à–∞ –≤–æ–ø—Ä–æ—Å–æ–≤
        function buildQuestionsCache() {
            gameData.questionsCache = new Map();
            let questionCounter = 1;
            
            if (!gameData.packageJson || !gameData.packageJson.rounds) return;
            
            // –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: rounds -> round[] -> themes -> theme[] -> questions -> question[]
            for (const round of gameData.packageJson.rounds) {
                if (!round || !round.round) continue;
                
                const roundArray = Array.isArray(round.round) ? round.round : [round.round];
                for (const roundItem of roundArray) {
                    if (!roundItem || !roundItem.themes) continue;
                    
                    const themes = Array.isArray(roundItem.themes) ? roundItem.themes : [roundItem.themes];
                    for (const themeData of themes) {
                        if (!themeData || !themeData.theme) continue;
                        
                        const themeArray = Array.isArray(themeData.theme) ? themeData.theme : [themeData.theme];
                        for (const theme of themeArray) {
                            if (!theme || !theme.questions) continue;
                            
                            const questions = Array.isArray(theme.questions) ? theme.questions : [theme.questions];
                            for (const qData of questions) {
                                if (!qData || !qData.question) continue;
                                
                                const questionArray = Array.isArray(qData.question) ? qData.question : [qData.question];
                                for (const q of questionArray) {
                                    if (!q) continue;
                                    
                                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ID (–∫–∞–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
                                    const idNum = questionCounter++;
                                    gameData.questionsCache.set(idNum, q);
                                }
                            }
                        }
                    }
                }
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ–¥–∏–∞ –∏–∑ –≤–æ–ø—Ä–æ—Å–∞
        function getQuestionMedia(question) {
            const media = [];
            
            if (!question.params) return media;
            
            const params = Array.isArray(question.params) ? question.params : [question.params];
            for (const paramGroup of params) {
                const paramList = Array.isArray(paramGroup.param) ? paramGroup.param : [paramGroup.param];
                for (const param of paramList) {
                    if (!param || !param.item) continue;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ - –Ω–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç —Ç–æ–ª—å–∫–æ "question"
                    if (param['@name'] !== 'question') continue;
                    
                    const items = Array.isArray(param.item) ? param.item : [param.item];
                    for (const item of items) {
                        if (typeof item === 'string') {
                            // –ü—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç
                            media.push({ type: 'text', content: item });
                        } else if (item['#text'] !== undefined) {
                            const text = item['#text'];
                            const type = item['@type'];
                            const isRef = item['@isRef'] === 'True' || item['@isRef'] === true;
                            
                            if (isRef && type) {
                                // –≠—Ç–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ –º–µ–¥–∏–∞ —Ñ–∞–π–ª
                                if (type === 'image' || text.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                                    media.push({ type: 'image', content: text });
                                } else if (type === 'video' || text.match(/\.(mp4|avi|mov|webm)$/i)) {
                                    media.push({ type: 'video', content: text });
                                } else if (type === 'audio' || text.match(/\.(mp3|wav|ogg)$/i)) {
                                    media.push({ type: 'audio', content: text });
                                } else {
                                    media.push({ type: 'text', content: text });
                                }
                            } else {
                                // –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
                                media.push({ type: 'text', content: text });
                            }
                        }
                    }
                }
            }
            
            return media;
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ–¥–∏–∞
        function displayMedia(media) {
            const centerZone = document.getElementById('centerZone');
            let html = '<div class="media-content">';
            
            switch (media.type) {
                case 'text':
                    html += `<div class="media-text">${media.content}</div>`;
                    break;
                case 'image':
                    const imageUrl = getMediaUrl(media.content);
                    if (imageUrl) {
                        html += `<img src="${imageUrl}" alt="Image" class="media-image">`;
                    } else {
                        html += `<div class="media-text">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${media.content}</div>`;
                    }
                    break;
                case 'video':
                    const videoUrl = getMediaUrl(media.content);
                    if (videoUrl) {
                        html += `<video src="${videoUrl}" controls class="media-video"></video>`;
                    } else {
                        html += `<div class="media-text">–í–∏–¥–µ–æ: ${media.content}</div>`;
                    }
                    break;
                case 'audio':
                    html += `<div class="media-audio">üéµ</div>`;
                    const audioUrl = getMediaUrl(media.content);
                    if (audioUrl) {
                        html += `<audio src="${audioUrl}" autoplay></audio>`;
                    }
                    break;
            }
            
            html += '</div>';
            centerZone.innerHTML = html;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ cananswer
        function handleCanAnswer(timestamp) {
            gameData.canAnswerTime = timestamp;
            const delay = timestamp - Date.now();
            
            if (delay > 0) {
                setTimeout(() => {
                    enableAnswerButton();
                    startAnswerTimer();
                }, delay);
            } else {
                enableAnswerButton();
                startAnswerTimer();
            }
        }

        // –í–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –æ—Ç–≤–µ—Ç–∏—Ç—å
        function enableAnswerButton() {
            const button = document.getElementById('answerButton');
            button.disabled = false;
        }

        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –æ—Ç–≤–µ—Ç–∏—Ç—å
        function disableAnswerButton() {
            const button = document.getElementById('answerButton');
            button.disabled = true;
        }

        // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ –æ—Ç–≤–µ—Ç–∞
        function startAnswerTimer() {
            if (gameData.progressTimer) {
                clearInterval(gameData.progressTimer);
            }
            
            if (!gameData.questionStartTime) {
                gameData.questionStartTime = Date.now();
            }
            
            const duration = gameData.questionDuration;
            
            gameData.progressTimer = setInterval(() => {
                const elapsed = Date.now() - gameData.questionStartTime;
                const remaining = Math.max(0, duration - elapsed);
                const percentage = (remaining / duration) * 100;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
                document.querySelectorAll('.player-progress-fill').forEach(bar => {
                    bar.style.width = percentage + '%';
                });
                
                if (remaining === 0) {
                    clearInterval(gameData.progressTimer);
                    disableAnswerButton();
                }
            }, 100);
        }

        // –ó–∞–º–æ—Ä–æ–∑–∫–∞ —Ç–∞–π–º–µ—Ä–∞
        function freezeTimer() {
            if (gameData.progressTimer) {
                clearInterval(gameData.progressTimer);
                gameData.progressTimer = null;
            }
            document.querySelectorAll('.player-progress-fill').forEach(bar => {
                bar.classList.add('frozen');
            });
        }

        // –†–∞–∑–º–æ—Ä–æ–∑–∫–∞ —Ç–∞–π–º–µ—Ä–∞
        function unfreezeTimer() {
            document.querySelectorAll('.player-progress-fill').forEach(bar => {
                bar.classList.remove('frozen');
            });
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Å —É—á–µ—Ç–æ–º –∑–∞–º–æ—Ä–æ–∑–∫–∏
            if (gameData.questionStartTime) {
                const elapsed = Date.now() - gameData.questionStartTime;
                gameData.questionStartTime = Date.now() - elapsed;
            }
            startAnswerTimer();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ waitanswer
        function handleWaitAnswer(waitingPlayerId) {
            freezeTimer();
            
            if (waitingPlayerId === playerId) {
                showAnswerWindow();
            }
        }

        // –ü–æ–∫–∞–∑ –æ–∫–Ω–∞ –æ—Ç–≤–µ—Ç–∞
        function showAnswerWindow() {
            const window = document.getElementById(`answer-window-${playerId}`);
            if (window) {
                window.classList.add('visible');
                const input = document.getElementById(`answer-input-${playerId}`);
                if (input) input.focus();
            }
        }

        // –°–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –æ—Ç–≤–µ—Ç–∞
        function hideAnswerWindow() {
            const window = document.getElementById(`answer-window-${playerId}`);
            if (window) {
                window.classList.remove('visible');
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞
        async function submitAnswer(playerId) {
            const input = document.getElementById(`answer-input-${playerId}`);
            const answerText = input ? input.value.trim() : '';
            
            if (!answerText) return; // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
            
            hideAnswerWindow();
            
            if (input) {
                input.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ
            }
            
            try {
                const formData = new URLSearchParams();
                formData.append('id-quest', gameData.selectedQuestionId);
                formData.append('id-player', playerId);
                formData.append('text', answerText);
                
                await fetch(`${getServerUrl()}/answer`, {
                    method: 'POST',
                    body: formData
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞:', error);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ validated
        function handleValidated(idQuest, idPlayer, result) {
            if (result) {
                // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                freezeTimer();
                disableAnswerButton();
                gameData.answeredQuestions.add(idQuest);
                updateScores();
            } else {
                // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                if (idPlayer === playerId) {
                    disableAnswerButton();
                } else {
                    unfreezeTimer();
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ showanswer
        async function handleShowAnswer(questId) {
            const answer = findAnswerById(questId);
            if (answer) {
                await displayAnswer(answer);
            }
        }

        // –ü–æ–∏—Å–∫ –æ—Ç–≤–µ—Ç–∞ –ø–æ ID –≤–æ–ø—Ä–æ—Å–∞
        function findAnswerById(questionId) {
            const question = findQuestionById(questionId);
            if (!question) return null;
            
            const media = [];
            
            // –ò—â–µ–º –æ—Ç–≤–µ—Ç –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –≤–æ–ø—Ä–æ—Å–∞
            if (question.right) {
                const rightData = Array.isArray(question.right) ? question.right[0] : question.right;
                if (rightData && rightData.answer) {
                    const answerData = Array.isArray(rightData.answer) ? answerData.answer[0] : rightData.answer;
                    if (answerData && answerData['#text']) {
                        media.push({ type: 'text', content: answerData['#text'] });
                    }
                }
            }
            
            // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º params —Å –∏–º–µ–Ω–µ–º "answer"
            if (question.params) {
                const params = Array.isArray(question.params) ? question.params : [question.params];
                for (const paramGroup of params) {
                    const paramList = Array.isArray(paramGroup.param) ? paramGroup.param : [paramGroup.param];
                    for (const param of paramList) {
                        if (param && param['@name'] === 'answer' && param.item) {
                            const items = Array.isArray(param.item) ? param.item : [param.item];
                            for (const item of items) {
                                if (typeof item === 'string') {
                                    media.push({ type: 'text', content: item });
                                } else if (item['#text'] !== undefined) {
                                    const text = item['#text'];
                                    const type = item['@type'];
                                    const isRef = item['@isRef'] === 'True' || item['@isRef'] === true;
                                    
                                    if (isRef && type) {
                                        if (type === 'image' || text.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                                            media.push({ type: 'image', content: text });
                                        } else if (type === 'video' || text.match(/\.(mp4|avi|mov|webm)$/i)) {
                                            media.push({ type: 'video', content: text });
                                        } else {
                                            media.push({ type: 'text', content: text });
                                        }
                                    } else {
                                        media.push({ type: 'text', content: text });
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            return media.length > 0 ? media : null;
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
        async function displayAnswer(mediaItems) {
            const centerZone = document.getElementById('centerZone');
            centerZone.classList.remove('hidden');
            
            if (mediaItems && mediaItems.length > 0) {
                for (let i = 0; i < mediaItems.length; i++) {
                    displayMedia(mediaItems[i]);
                    if (i < mediaItems.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
            } else {
                centerZone.innerHTML = '<div class="loading">–û—Ç–≤–µ—Ç</div>';
            }
        }

        // –†–µ–ø–ª–∏–∫–∞ –≤–µ–¥—É—â–µ–≥–æ
        function showmanTalk(text) {
            document.getElementById('hostBubble').textContent = text;
            addLog(`–í–µ–¥—É—â–∏–π: ${text}`);
        }

        // –†–µ–ø–ª–∏–∫–∞ –∏–≥—Ä–æ–∫–∞
        function playerTalk(playerId, text) {
            const bubble = document.getElementById(`bubble-${playerId}`);
            if (bubble) {
                bubble.textContent = text;
            }
            addLog(`–ò–≥—Ä–æ–∫ ${playerId}: ${text}`);
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –ª–æ–≥
        function addLog(message) {
            const logZone = document.getElementById('logZone');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logZone.appendChild(entry);
            logZone.scrollTop = logZone.scrollHeight;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –æ—Ç–≤–µ—Ç–∏—Ç—å
        document.getElementById('answerButton').addEventListener('click', async () => {
            const button = document.getElementById('answerButton');
            if (button.disabled) return;
            
            disableAnswerButton();
            
            try {
                const formData = new URLSearchParams();
                formData.append('id', playerId);
                formData.append('timestamp', Date.now().toString());
                
                await fetch(`${getServerUrl()}/requestanswer`, {
                    method: 'POST',
                    body: formData
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ requestanswer:', error);
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', init);
    </script>

    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
</body>
</html>
