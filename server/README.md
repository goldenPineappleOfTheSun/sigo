# Игровой сервер на Go

Сервер для игры в викторину с поддержкой HTTP и WebSocket.

## Установка

1. Убедитесь, что у вас установлен Go 1.21 или выше
2. Установите зависимости:
```bash
cd server
go mod download
```

## Запуск

```bash
go run main.go
```

Сервер запустится на порту 8080.

## Структура проекта

- `main.go` - основной файл сервера
- `go.mod` - файл зависимостей
- `package/` - папка для загруженных пакетов (создается автоматически)
- `players/` - папка для фотографий игроков (создается автоматически)

## API Эндпоинты

### POST /upload
Загружает пакет игры (JSON файл и медиафайлы).

**Формат запроса:** multipart/form-data
- `data`: JSON файл с вопросами
- `media`: массив медиафайлов

**Структура JSON файла:**
```json
{
  "rounds": [
    {
      "themes": [
        {
          "name": "Название темы",
          "questions": [
            {
              "id": 1,
              "price": 100,
              "text": "Текст вопроса",
              "answer": "Правильный ответ",
              "comment": "Комментарий ведущего"
            }
          ]
        }
      ]
    }
  ]
}
```

### POST /join
Присоединение игрока к игре.

**Формат запроса:** multipart/form-data
- `id`: число (ID игрока)
- `name`: строка (имя игрока)
- `photo`: изображение (фото игрока)

### POST /joinnpc
Добавление NPC (бот) в игру.

**Формат запроса:** application/x-www-form-urlencoded
- `character`: строка (имя персонажа)

NPC получает автоматический ID начиная с 100.

### POST /start
Начинает игру. Переводит сервер в состояние `select-question`.

### GET /state
Возвращает текущее состояние игры:
- `joining` - ожидание игроков
- `select-question` - выбор вопроса
- `wait-acknowledge` - ожидание подтверждения
- `question` - показ вопроса
- `wait-answer` - ожидание ответа
- `show-answer` - показ ответа
- `unknown` - игра завершена

### GET /scores
Возвращает JSON с очками всех игроков:
```json
[
  {"id": 1, "name": "Игрок 1", "score": 200},
  {"id": 2, "name": "Игрок 2", "score": -100}
]
```

### GET /data
Возвращает JSON пакета и список игроков:
```json
{
  "packageJson": { /* содержимое JSON-файла */ },
  "players": [
    {"id": 1, "name": "Игрок 1"},
    {"id": 2, "name": "Игрок 2"}
  ]
}
```

### GET /media
Возвращает ZIP архив со всеми медиафайлами из пакета и фотографиями игроков.

### GET /currentplayer
Возвращает ID текущего игрока (чей ход).

### GET /playerstate?id=1
Возвращает имя и очки игрока:
```json
{
  "name": "Игрок 1",
  "score": 200
}
```

### POST /selectquestion
Выбор вопроса текущим игроком.

**Формат запроса:** application/x-www-form-urlencoded
- `idQuest`: число (ID вопроса)
- `idPlayer`: число (ID игрока)

### POST /acknowledge
Подтверждение просмотра выбранного вопроса.

**Формат запроса:** application/x-www-form-urlencoded
- `id`: число (ID игрока)

### POST /questionbeenshown
Уведомление о том, что игрок просмотрел вопрос.

**Формат запроса:** application/x-www-form-urlencoded
- `playerId`: число (ID игрока)

### POST /requestanswer
Запрос на возможность ответить.

**Формат запроса:** application/x-www-form-urlencoded
- `id`: число (ID игрока)
- `timestamp`: число (UTC время в миллисекундах)

### POST /answer
Отправка ответа на вопрос.

**Формат запроса:** application/x-www-form-urlencoded
- `id-quest`: число (ID вопроса)
- `id-player`: число (ID игрока)
- `text`: строка (текст ответа)

## WebSocket

### Подключение
```
ws://localhost:8080/ws
```

### Сообщения от сервера

Все сообщения отправляются в формате JSON с полем `type`:

1. **questionstable** - таблица вопросов
```json
{
  "type": "questionstable",
  "table": "Темы:\n..."
}
```

2. **questionselected** - вопрос выбран
```json
{
  "type": "questionselected",
  "id": 1,
  "isspecial": false
}
```

3. **showquestion** - показ вопроса
```json
{
  "type": "showquestion",
  "id": 1,
  "time": 1234567890000
}
```

4. **cananswer** - можно отвечать
```json
{
  "type": "cananswer",
  "timestamp": 1234567890000
}
```

5. **waitanswer** - ожидание ответа от игрока
```json
{
  "type": "waitanswer",
  "playerId": 1
}
```

6. **validated** - результат проверки ответа
```json
{
  "type": "validated",
  "idQuest": 1,
  "idPlayer": 1,
  "result": true
}
```

7. **showanswer** - показ ответа
```json
{
  "type": "showanswer",
  "questId": 1
}
```

8. **showmantalk** - реплика ведущего
```json
{
  "type": "showmantalk",
  "text": "Комментарий ведущего"
}
```

9. **playertalk** - ответ игрока
```json
{
  "type": "playertalk",
  "playerId": 1,
  "text": "Ответ игрока"
}
```

## Логика игры

1. **Начало игры:**
   - Загружается пакет через `/upload`
   - Игроки присоединяются через `/join` или `/joinnpc`
   - Игра начинается через `/start`

2. **Ход игры:**
   - Текущий игрок выбирает вопрос через `/selectquestion`
   - Все игроки подтверждают просмотр через `/acknowledge`
   - Вопрос показывается всем
   - Игроки могут запросить возможность ответить через `/requestanswer`
   - Первый запросивший получает право ответить
   - Ответ отправляется через `/answer`
   - Если ответ верный, игра переходит к следующему вопросу
   - Если никто не ответил верно, NPC пытаются ответить
   - Если все вопросы раунда отвечены, начинается следующий раунд

3. **NPC:**
   - NPC автоматически выбирают вопросы и отвечают
   - Если никто не ответил верно, NPC пытаются ответить по очереди

## Обработка ошибок

Если запрос не соответствует текущему состоянию игры или нарушает правила, сервер отвечает кодом 400 и не изменяет состояние.

